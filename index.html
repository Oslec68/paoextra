<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Visita Lojas GPA</title>
<style>
:root { --azul:#1e3a8a; --verde:#0a7a3c; }
*{margin:0;padding:0;box-sizing:border-box}
body{font:14px Arial;background:#f5f5f5;color:#111;min-height:100vh;display:flex;flex-direction:column}
header{background:var(--azul);text-align:center;padding:15px 0;color:#fff}
header h1{font-size:22px;margin-bottom:5px}
header small{font-size:12px;opacity:0.9}
form{flex:1;padding:10px}
section{background:#fff;margin:10px 0;padding:15px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
label{display:block;font-size:12px;font-weight:bold;margin-bottom:5px;color:#333}
input,textarea{width:100%;padding:10px;font-size:14px;border:1px solid #ddd;border-radius:6px;margin-bottom:10px}
input:focus,textarea:focus{outline:none;border-color:var(--azul)}
input[readonly]{background:#f5f5f5;color:#666}
textarea{height:60px;resize:none;font-family:inherit}
.row{display:flex;gap:10px}
.row > div{flex:1}
.cod{flex:0 0 80px}
button{padding:12px 20px;font-size:14px;font-weight:bold;border:none;border-radius:6px;cursor:pointer;margin:5px}
.btn-toggle{background:#e9ecef;color:#333;width:100%}
.btn-toggle:hover{background:#dee2e6}
.btn-limpar{background:#6c757d;color:#fff}
.btn-finalizar{background:var(--verde);color:#fff}
.btn-limpar:hover{background:#5a6268}
.btn-finalizar:hover{background:#087a32}
.hidden{display:none}

/* Estilos do checklist */
.chk-item{
  display:flex;
  align-items:flex-start;
  gap:10px;
  padding:15px;
  border:1px solid #e9ecef;
  border-radius:8px;
  margin-bottom:10px;
  background:#f8f9fa;
  flex-wrap:wrap;
}
.chk-item input[type="checkbox"]{
  width:18px;
  height:18px;
  margin:0;
  flex-shrink:0;
  margin-top:2px;
}
.chk-item .item-label{
  flex:1;
  font-weight:500;
  min-width:120px;
  font-size:14px;
}
.emoji-group{
  display:flex;
  gap:8px;
  align-items:center;
  flex-shrink:0;
}
.emoji{
  font-size:24px;
  cursor:pointer;
  transition:all 0.2s ease;
  padding:4px;
  border-radius:50%;
  user-select:none;
}
.emoji:hover{
  transform:scale(1.2);
  background:rgba(0,0,0,0.1);
}
.emoji.selecionado{
  outline:3px solid #007bff;
  background:#e3f2fd;
  transform:scale(1.1);
}
.chk-item .situacao-field{
  flex:1;
  min-width:200px;
  padding:8px 35px 8px 12px;
  border:1px solid #ddd;
  border-radius:6px;
  font-size:13px;
  background:#fff;
  margin:0;
  flex-basis:100%;
  margin-top:8px;
  position:relative;
}
.chk-item .situacao-field:focus{
  outline:none;
  border-color:var(--azul);
  box-shadow:0 0 0 2px rgba(30,58,138,0.1);
}
.chk-item .situacao-field::placeholder{
  color:#999;
  font-style:italic;
}

/* Campo de situaÃ§Ã£o com microfone */
.situacao-container{
  position:relative;
  flex:1;
  flex-basis:100%;
  margin-top:8px;
}
.mic-btn{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  font-size:16px;
  cursor:pointer;
  padding:4px;
  border-radius:4px;
  transition:all 0.2s ease;
  z-index:10;
}
.mic-btn:hover{
  background:#f0f0f0;
}
.mic-btn.recording{
  color:#dc3545;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%{transform:translateY(-50%) scale(1)}
  50%{transform:translateY(-50%) scale(1.1)}
  100%{transform:translateY(-50%) scale(1)}
}

/* Campo de observaÃ§Ãµes com microfone */
.obs-container{
  position:relative;
}
.obs-container .mic-btn{
  top:15px;
  transform:none;
}

.checkbox-item{display:flex;align-items:center;gap:8px;padding:5px;border-radius:4px;margin-bottom:3px}
.checkbox-item:hover{background:#f8f9fa}
.checkbox-item input[type="checkbox"]{width:16px;height:16px;margin:0}
.checkbox-item .texto{flex:1;font-size:13px}
.btn-excluir{background:#dc3545;color:white;border:none;border-radius:3px;padding:2px 6px;font-size:10px;cursor:pointer}
.btn-excluir:hover{background:#c82333}
.metrics{background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px}
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
footer{background:#fff;padding:15px;display:flex;gap:10px;box-shadow:0 -2px 4px rgba(0,0,0,0.1)}
footer button{flex:1}
#status{text-align:center;padding:10px;font-weight:bold}

/* Weather display */
.weather-info{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:8px;
}
.weather-info span{
  font-size:12px;
}
</style>
</head>
<body>

<header>
  <h1>ğŸ›’ Visita Lojas GPA</h1>
  <small id="clock"></small>
  <div class="weather-info">
    <span id="weather-emoji">ğŸŒ¤ï¸</span>
    <span id="weather-desc">Campinas â€¢ Tarde</span>
    <span id="temp">26Â°C</span>
  </div>
</header>

<form>
<section>
  <div class="row">
    <div class="cod">
      <label>CÃ³digo</label>
      <input id="cod" maxlength="4" placeholder="0000">
    </div>
    <div>
      <label>Nome da Loja</label>
      <input id="nome" readonly placeholder="Digite o cÃ³digo da loja">
    </div>
  </div>
  <div>
    <label>Cidade</label>
    <input id="cidade" readonly placeholder="Cidade serÃ¡ preenchida automaticamente">
  </div>
</section>

<section>
  <div class="row">
    <div>
      <label>Gerente</label>
      <input id="gerente" placeholder="Nome do gerente">
    </div>
    <div>
      <label>WhatsApp</label>
      <input id="whats" placeholder="(11) 99999-9999">
    </div>
  </div>
</section>

<section>
  <label>UsuÃ¡rio</label>
  <input id="usuario" placeholder="Seu nome">
  
  <button type="button" class="btn-toggle" onclick="toggleMetricas()">ğŸ“Š MÃ©tricas <span id="badge-metrics">(0)</span></button>
  
  <div id="metricas" class="hidden">
    <div class="metrics">
      <div class="metrics-grid">
        <div>
          <label>ğŸ’° Venda Mensal (R$)</label>
          <input id="venda" placeholder="0,00">
        </div>
        <div>
          <label>ğŸ“ˆ VariaÃ§Ã£o (%)</label>
          <input id="variacao" placeholder="0" type="number">
        </div>
        <div>
          <label>ğŸ“‰ Perda (R$)</label>
          <input id="perda" placeholder="0,00">
        </div>
        <div>
          <label>ğŸš« Ruptura (%)</label>
          <input id="ruptura" placeholder="0" type="number" max="100">
        </div>
      </div>
    </div>
  </div>
</section>

<section>
  <button type="button" class="btn-toggle" onclick="toggleChecklist()">ğŸ“‹ Checklist <span id="badge-check">(0)</span></button>
  
  <div id="checklistSec">
    <section>
      <div class="chk-group" id="lista">
        <div class="chk-item">
          <input type="checkbox" value="Ruptura" onchange="contarChecklist()">
          <span class="item-label">Ruptura</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: 5% falta aÃ§Ãºcar, 10% falta arroz">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
        <div class="chk-item">
          <input type="checkbox" value="PreÃ§o errado" onchange="contarChecklist()">
          <span class="item-label">PreÃ§o errado</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: Leite R$ 6,50 deveria ser R$ 5,90">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
        <div class="chk-item">
          <input type="checkbox" value="Layout inadequado" onchange="contarChecklist()">
          <span class="item-label">Layout inadequado</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: Produtos mal organizados na gÃ´ndola">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
        <div class="chk-item">
          <input type="checkbox" value="Limpeza" onchange="contarChecklist()">
          <span class="item-label">Limpeza</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: ChÃ£o sujo no corredor 3, prateleiras empoeiradas">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
        <div class="chk-item">
          <input type="checkbox" value="Atendimento" onchange="contarChecklist()">
          <span class="item-label">Atendimento</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: FuncionÃ¡rios sem uniforme, atendimento lento">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
        <div class="chk-item">
          <input type="checkbox" value="ExposiÃ§Ã£o" onchange="contarChecklist()">
          <span class="item-label">ExposiÃ§Ã£o</span>
          <div class="emoji-group">
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
            <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
          </div>
          <div class="situacao-container">
            <input type="text" class="situacao-field" placeholder="Ex: Produtos vencidos expostos, falta iluminaÃ§Ã£o">
            <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
          </div>
        </div>
      </div>
      <div class="row">
        <input id="novo" placeholder="Outro item">
        <button type="button" class="chk-btn" style="flex:0 0 60px" onclick="adicionarItem()">+Add</button>
      </div>
    </section>
  </div>
</section>

<section>
  <label>ObservaÃ§Ãµes</label>
  <div class="obs-container">
    <textarea id="obs" placeholder="ObservaÃ§Ãµes da visita"></textarea>
    <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
  </div>
</section>

<section>
  <label>Fotos</label>
  <div style="display:flex;gap:10px;align-items:center">
    <input type="file" id="fotos" accept="image/*" multiple style="flex:1">
    <button type="button" onclick="abrirCamera()" style="padding:10px 15px;background:#007bff;color:white;border:none;border-radius:6px;font-size:12px;font-weight:bold">ğŸ“· CÃ¢mera</button>
  </div>
  <input type="file" id="camera" accept="image/*" capture="environment" style="display:none">
</section>

<div id="status"></div>

<footer>
  <button type="button" class="btn-limpar" onclick="limpar()">ğŸ—‘ï¸ Limpar</button>
  <button type="button" class="btn-finalizar" onclick="finalizar()">âœ… Finalizar</button>
</footer>

<script>
// DADOS DAS LOJAS
const lojas = {
  "0001": {"nome": "PA JARDIM PAULISTA", "cidade": "SAO PAULO"},
  "0003": {"nome": "PA NOVA ALIANCA", "cidade": "RIBEIRAO PRETO"},
  "0004": {"nome": "PA ANALIA FRANCO", "cidade": "SAO PAULO"},
  "0014": {"nome": "PA SOROCABA A B VIST", "cidade": "SOROCABA"},
  "0018": {"nome": "PA SANTOS CENTRO", "cidade": "SANTOS"},
  "0022": {"nome": "PA VALINHOS PORTAL", "cidade": "VALINHOS"},
  "0026": {"nome": "PA CAMPINAS CASTELO", "cidade": "CAMPINAS"},
  "0037": {"nome": "PA CAMPINAS CAMBUI", "cidade": "CAMPINAS"},
  "0044": {"nome": "EX SANTOS MACUCO", "cidade": "SANTOS"},
  "0052": {"nome": "PA GUARUJA PUGLISI", "cidade": "GUARUJA"},
  "0069": {"nome": "EX P. G. CENTRO", "cidade": "PRAIA GRANDE"},
  "0122": {"nome": "PA ARACATUBA", "cidade": "ARACATUBA"},
  "0186": {"nome": "PA TAUBATE INDEP", "cidade": "TAUBATE"},
  "0189": {"nome": "PA CAMPINAS PROENCA", "cidade": "CAMPINAS"},
  "0205": {"nome": "PA S.VICENTE ITARARE", "cidade": "SAO VICENTE"},
  "0334": {"nome": "HUB FRESH - 0018", "cidade": "SANTOS"},
  "0361": {"nome": "PA AQUARIUS", "cidade": "SAO JOSE DOS CAMPOS"},
  "0412": {"nome": "PA HIPICA", "cidade": "CAMPINAS"},
  "0465": {"nome": "PA JUNDIAI", "cidade": "JUNDIAI"},
  "0505": {"nome": "PA CAMPINAS MANSOES", "cidade": "CAMPINAS"},
  "0506": {"nome": "PA ITU CENTRO II", "cidade": "ITU"},
  "0507": {"nome": "PA SALTO GETULIO VAR", "cidade": "SALTO"},
  "0508": {"nome": "PA ATIBAIA", "cidade": "ATIBAIA"},
  "0660": {"nome": "PA SOROCABA CAMPOLIM", "cidade": "SOROCABA"},
  "0692": {"nome": "EX SANTOS PEDREIRA", "cidade": "SANTOS"},
  "0745": {"nome": "PA PRAIA GRD C FORTE", "cidade": "PRAIA GRANDE"},
  "1002": {"nome": "PA ITU CENTRO", "cidade": "ITU"},
  "1005": {"nome": "PA PERUIBE", "cidade": "PERUIBE"},
  "1021": {"nome": "PA RIB PRETO INDEPEN", "cidade": "RIBEIRAO PRETO"},
  "1175": {"nome": "PA S.J.C. SHOPPING", "cidade": "SAO JOSE DOS CAMPOS"},
  "1182": {"nome": "PA ARARAQUARA SHOPP", "cidade": "ARARAQUARA"},
  "1185": {"nome": "VINHEDO", "cidade": "VINHEDO"},
  "1191": {"nome": "PA PRES PRUDENTE", "cidade": "PRESIDENTE PRUDENTE"},
  "1200": {"nome": "PA ASSIS", "cidade": "ASSIS"},
  "1293": {"nome": "PA BARAO GERALDO", "cidade": "CAMPINAS"},
  "1312": {"nome": "PA SAO CARLOS", "cidade": "SAO CARLOS"},
  "1386": {"nome": "PA JUNDIAI CENTRO", "cidade": "JUNDIAI"},
  "1499": {"nome": "EX P. G. FORTE", "cidade": "PRAIA GRANDE"},
  "1609": {"nome": "PA AVARE", "cidade": "AVARE"},
  "1724": {"nome": "PA RIBEIRAO PRETO JD", "cidade": "RIBEIRAO PRETO"},
  "1739": {"nome": "PA ATIBAIA JARDIM", "cidade": "ATIBAIA"},
  "1745": {"nome": "EX SANTOS APARECIDA", "cidade": "SANTOS"},
  "1748": {"nome": "EX MONGAGUA", "cidade": "MONGAGUA"},
  "1750": {"nome": "EX SANTOS VILA NOV", "cidade": "SANTOS"},
  "1751": {"nome": "PA PERUIBE CENTRO", "cidade": "PERUIBE"},
  "1753": {"nome": "PA PRAIA GRD BOQUIA", "cidade": "PRAIA GRANDE"},
  "1758": {"nome": "PA SANTOS BARTOLOMEU", "cidade": "SANTOS"},
  "1774": {"nome": "PA SAO SEBASTIAO", "cidade": "SAO SEBASTIAO"},
  "1875": {"nome": "EX GUARUJA JARDIM", "cidade": "GUARUJA"},
  "1878": {"nome": "PA CAMPINAS SOUZA", "cidade": "CAMPINAS"},
  "2050": {"nome": "PA RIVIERA SHOPPING", "cidade": "BERTIOGA"},
  "2078": {"nome": "PA ITANHAEM", "cidade": "ITANHAEM"},
  "2329": {"nome": "PA PIRACICABA", "cidade": "PIRACICABA"},
  "2333": {"nome": "PA TAUBATE VILA SAO", "cidade": "TAUBATE"},
  "2354": {"nome": "PA GUARUJA TEJEREBA", "cidade": "GUARUJA"},
  "2373": {"nome": "PA PARQUE PRADO", "cidade": "CAMPINAS"},
  "2402": {"nome": "PA S J DO RIO PRETO", "cidade": "SAO JOSE RIO PRETO"},
  "2424": {"nome": "PA S.J.R.P. JOCKEY", "cidade": "SAO JOSE DO RIO PRET"},
  "2432": {"nome": "PA GUARUJA PITANGU", "cidade": "GUARUJA"},
  "2438": {"nome": "PA JOSE MENINO", "cidade": "SANTOS"},
  "2449": {"nome": "PA BAURU JD. ESTORIL", "cidade": "BAURU"},
  "2465": {"nome": "PA CAMPINAS ITAPURA", "cidade": "CAMPINAS"},
  "2474": {"nome": "PA MARILIA", "cidade": "MARILIA"},
  "2481": {"nome": "PA BOTUCATU", "cidade": "BOTUCATU"},
  "5171": {"nome": "PA LIMEIRA JD PARQUE", "cidade": "LIMEIRA"},
  "5659": {"nome": "BARATEIRO LEME", "cidade": "LEME"},
  "5679": {"nome": "COMPRE BEM GUARUJA", "cidade": "GUARUJA"},
  "5680": {"nome": "COMPRE BEM SANTOS", "cidade": "SANTOS"},
  "5682": {"nome": "EX GUARUJA JOAO PES", "cidade": "GUARUJA"},
  "5683": {"nome": "BARATEIRO BEBEDOURO", "cidade": "BEBEDOURO"},
  "6767": {"nome": "PA PIRACICABA PAULIS", "cidade": "PIRACICABA"},
  "8666": {"nome": "PA RIBEIRAO PRETO", "cidade": "RIBEIRAO PRETO"}
};

// CONFIGURAÃ‡ÃƒO DO TELEGRAM
const BOT_TOKEN = "7650475884:AAEicrlr9uiaRJQEMHAAyU2Oh3lAkqVzoTQ";
const CHAT_ID = "1491404284";

// FUNÃ‡ÃƒO DE BUSCA DA LOJA
function buscarLoja() {
  const codigo = document.getElementById('cod').value;
  
  if (codigo.length === 4) {
    const loja = lojas[codigo];
    if (loja) {
      document.getElementById('nome').value = loja.nome;
      document.getElementById('cidade').value = loja.cidade;
      updateWeather(loja.cidade);
    } else {
      document.getElementById('nome').value = 'Loja nÃ£o encontrada';
      document.getElementById('cidade').value = '';
    }
  } else {
    document.getElementById('nome').value = '';
    document.getElementById('cidade').value = '';
  }
}

// FUNÃ‡ÃƒO DE CLIMA
function updateWeather(cidade) {
  const agora = new Date();
  const hora = agora.getHours();
  let icon, desc, temp;
  
  const isInterior = !['SAO PAULO', 'SANTOS', 'GUARUJA', 'PRAIA GRANDE', 'SAO VICENTE'].includes(cidade.toUpperCase());
  const tempAdjust = isInterior ? 2 : 0;
  
  if (hora >= 6 && hora < 12) {
    icon = 'ğŸŒ…'; desc = 'ManhÃ£'; temp = `${18 + tempAdjust}`;
  } else if (hora >= 12 && hora < 18) {
    icon = 'â˜€ï¸'; desc = 'Tarde'; temp = `${26 + tempAdjust}`;
  } else if (hora >= 18 && hora < 21) {
    icon = 'ğŸŒ‡'; desc = 'Entardecer'; temp = `${22 + tempAdjust}`;
  } else {
    icon = 'ğŸŒ™'; desc = 'Noite'; temp = `${18 + tempAdjust}`;
  }
  
  document.getElementById('temp').textContent = `${temp}Â°C`;
  document.getElementById('weather-desc').textContent = `${cidade} â€¢ ${desc}`;
  document.getElementById('weather-emoji').textContent = icon;
}

// FUNÃ‡Ã•ES DOS BOTÃ•ES
function toggleChecklist() {
  const sec = document.getElementById('checklistSec');
  if (sec.style.display === 'none' || sec.style.display === '') {
    sec.style.display = 'block';
  } else {
    sec.style.display = 'none';
  }
}

function toggleMetricas() {
  const div = document.getElementById('metricas');
  if (div) div.classList.toggle('hidden');
}

function contarMetricas() {
  const inputs = document.querySelectorAll('#metricas input');
  let count = 0;
  inputs.forEach(input => {
    if (input.value.trim() !== '') count++;
  });
  document.getElementById('badge-metrics').textContent = `(${count})`;
}

// FUNÃ‡ÃƒO DE RECONHECIMENTO DE VOZ
let recognition = null;

function iniciarDitado(botao) {
  // Verifica se o navegador suporta Speech Recognition
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('ğŸ¤ Seu navegador nÃ£o suporta reconhecimento de voz. Use Chrome ou Edge.');
    return;
  }
  
  // Encontra o campo de texto relacionado
  const container = botao.parentElement;
  const campo = container.querySelector('input, textarea');
  
  if (!campo) return;
  
  // Configura o reconhecimento de voz
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  
  recognition.lang = 'pt-BR';
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  // Visual de gravando
  botao.classList.add('recording');
  botao.textContent = 'â¹ï¸';
  campo.placeholder = 'Falando... clique no microfone para parar';
  
  console.log('ğŸ¤ Iniciando reconhecimento de voz...');
  
  recognition.onstart = function() {
    console.log('ğŸ¤ Reconhecimento iniciado');
  };
  
  recognition.onresult = function(event) {
    const texto = event.results[0][0].transcript;
    console.log('ğŸ¤ Texto reconhecido:', texto);
    
    // Adiciona o texto ao campo (ou substitui se estava vazio)
    if (campo.value.trim() === '') {
      campo.value = texto;
    } else {
      campo.value += ' ' + texto;
    }
    
    finalizarDitado(botao, campo);
  };
  
  recognition.onerror = function(event) {
    console.error('âŒ Erro no reconhecimento:', event.error);
    let mensagem = 'Erro no reconhecimento de voz';
    
    switch(event.error) {
      case 'no-speech':
        mensagem = 'Nenhuma fala detectada. Tente novamente.';
        break;
      case 'audio-capture':
        mensagem = 'Microfone nÃ£o encontrado ou sem permissÃ£o.';
        break;
      case 'not-allowed':
        mensagem = 'PermissÃ£o para microfone negada. Clique no Ã­cone da cÃ¢mera na barra de endereÃ§os.';
        break;
    }
    
    alert('ğŸ¤ ' + mensagem);
    finalizarDitado(botao, campo);
  };
  
  recognition.onend = function() {
    console.log('ğŸ¤ Reconhecimento finalizado');
    finalizarDitado(botao, campo);
  };
  
  // Inicia o reconhecimento
  recognition.start();
  
  // Se clicar no botÃ£o novamente, para a gravaÃ§Ã£o
  botao.onclick = function() {
    if (recognition) {
      recognition.stop();
    }
  };
}

function finalizarDitado(botao, campo) {
  botao.classList.remove('recording');
  botao.textContent = 'ğŸ¤';
  campo.placeholder = campo.getAttribute('data-original-placeholder') || 
                     (campo.tagName === 'TEXTAREA' ? 'ObservaÃ§Ãµes da visita' : 'Descreva a situaÃ§Ã£o encontrada...');
  
  // Restaura funÃ§Ã£o original do botÃ£o
  botao.onclick = function() {
    iniciarDitado(botao);
  };
  
  recognition = null;
}

function contarChecklist() {
  const checked = document.querySelectorAll('#lista input[type="checkbox"]:checked').length;
  document.getElementById('badge-check').textContent = `(${checked})`;
}

// FUNÃ‡ÃƒO SIMPLES PARA SELECIONAR EMOJI
function selecionarEmoji(el) {
  console.log('ğŸ¯ Emoji clicado:', el.textContent);
  
  // Encontra o grupo de emojis e remove seleÃ§Ã£o de todos
  const grupo = el.parentElement;
  grupo.querySelectorAll('.emoji').forEach(e => e.classList.remove('selecionado'));
  
  // Adiciona seleÃ§Ã£o no emoji clicado
  el.classList.add('selecionado');
  
  // Marca automaticamente o checkbox
  const item = el.closest('.chk-item');
  const checkbox = item.querySelector('input[type="checkbox"]');
  checkbox.checked = true;
  
  // Atualiza contador
  contarChecklist();
  
  console.log('âœ… Emoji selecionado com sucesso');
}

function adicionarItem() {
  const txt = document.getElementById('novo').value.trim();
  if (!txt) return;
  
  const novoItem = document.createElement('div');
  novoItem.className = 'chk-item';
  
  novoItem.innerHTML = `
    <input type="checkbox" value="${txt}" onchange="contarChecklist()">
    <span class="item-label">${txt}</span>
    <div class="emoji-group">
      <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¢</span>
      <span class="emoji" onclick="selecionarEmoji(this)">ğŸŸ¡</span>
      <span class="emoji" onclick="selecionarEmoji(this)">ğŸ”´</span>
    </div>
    <div class="situacao-container">
      <input type="text" class="situacao-field" placeholder="Descreva a situaÃ§Ã£o encontrada...">
      <button type="button" class="mic-btn" onclick="iniciarDitado(this)">ğŸ¤</button>
    </div>
  `;
  
  document.getElementById('lista').appendChild(novoItem);
  document.getElementById('novo').value = '';
  contarChecklist();
}

// Remove a funÃ§Ã£o setStatus que nÃ£o precisamos mais

function abrirCamera() {
  // Input especÃ­fico para cÃ¢mera
  const inputCamera = document.getElementById('camera');
  inputCamera.click();
  
  console.log('ğŸ“· Abrindo cÃ¢mera para nova foto');
}

function formatarMoeda(input) {
  let value = input.value.replace(/\D/g, '');
  if (value) {
    value = parseInt(value, 10);
    input.value = (value / 100).toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    });
  }
}

// FUNÃ‡ÃƒO DE ENVIO PARA TELEGRAM
async function finalizar() {
  const codigo = document.getElementById('cod').value;
  const usuario = document.getElementById('usuario').value;
  
  if (!codigo || !usuario) {
    document.getElementById('status').innerHTML = '<span style="color:red">âš ï¸ Preencha cÃ³digo da loja e usuÃ¡rio</span>';
    return;
  }
  
  // Coleta dados do checklist com status e situaÃ§Ãµes
  const checklistItems = [...document.querySelectorAll('#lista .chk-item')]
    .filter(item => item.querySelector('input[type="checkbox"]').checked)
    .map(item => {
      const nome = item.querySelector('.item-label').textContent;
      const situacao = item.querySelector('.situacao-field').value;
      const emojiSelecionado = item.querySelector('.emoji.selecionado');
      
      let status = '';
      if (emojiSelecionado) {
        status = emojiSelecionado.textContent + ' ';
      }
      
      let linha = `${status}${nome}`;
      if (situacao) linha += `: ${situacao}`;
      
      return linha;
    });
  
  const checklistTexto = checklistItems.length > 0 ? checklistItems.join('\nâ€¢ ') : 'Nenhum problema encontrado';
  
  // Monta mensagem para Telegram
  const mensagem = "ğŸ›’ *Visita GPA*\n\n" +
                  "ğŸª *Loja:* " + document.getElementById('nome').value + " (" + codigo + ")\n" +
                  "ğŸ“ *Cidade:* " + document.getElementById('cidade').value + "\n" +
                  "ğŸ‘¤ *Gerente:* " + (document.getElementById('gerente').value || "â€”") + "\n" +
                  "ğŸ“± *WhatsApp:* " + (document.getElementById('whats').value || "â€”") + "\n" +
                  "ğŸ” *Auditor:* " + usuario + "\n\n" +
                  "ğŸ“‹ *Checklist:*\nâ€¢ " + checklistTexto + "\n\n" +
                  "ğŸ“ *ObservaÃ§Ãµes:* " + (document.getElementById('obs').value || "â€”");
  
  try {
    document.getElementById('status').innerHTML = '<span style="color:blue">ğŸ“¤ Enviando...</span>';
    
    await fetch("https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        chat_id: CHAT_ID, 
        text: mensagem, 
        parse_mode: 'Markdown' 
      })
    });
    
    document.getElementById('status').innerHTML = '<span style="color:green">âœ… Enviado para Telegram!</span>';
  } catch(e) {
    document.getElementById('status').innerHTML = '<span style="color:red">âŒ Erro no envio</span>';
  }
}

function limpar() {
  if (confirm('Limpar todos os dados?')) {
    document.querySelectorAll('input, textarea').forEach(el => {
      if (el.type === 'checkbox') el.checked = false;
      else el.value = '';
    });
    
    // Remove seleÃ§Ãµes dos emojis
    document.querySelectorAll('.emoji').forEach(emoji => emoji.classList.remove('selecionado'));
    
    document.getElementById('checklistSec').style.display = 'none';
    document.getElementById('badge-check').textContent = '(0)';
    document.getElementById('badge-metrics').textContent = '(0)';
    document.getElementById('status').innerHTML = '';
    updateWeather('CAMPINAS');
  }
}

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleString('pt-BR');
}

// EVENTO PARA BUSCA DE LOJA
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('cod').addEventListener('input', buscarLoja);
  
  // EVENTOS PARA MÃ‰TRICAS
  document.getElementById('venda').addEventListener('input', contarMetricas);
  document.getElementById('venda').addEventListener('blur', function() { formatarMoeda(this); });
  document.getElementById('variacao').addEventListener('input', contarMetricas);
  document.getElementById('perda').addEventListener('input', contarMetricas);
  document.getElementById('perda').addEventListener('blur', function() { formatarMoeda(this); });
  document.getElementById('ruptura').addEventListener('input', contarMetricas);
  
  // SALVA PLACEHOLDERS ORIGINAIS PARA O SPEECH-TO-TEXT
  document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(campo => {
    campo.setAttribute('data-original-placeholder', campo.placeholder);
  });
  
  // SINCRONIZA FOTOS DA CÃ‚MERA COM O INPUT PRINCIPAL
  document.getElementById('camera').addEventListener('change', function() {
    const fotosInput = document.getElementById('fotos');
    const cameraFiles = this.files;
    
    if (cameraFiles.length > 0) {
      // Cria um novo FileList combinando fotos existentes + nova da cÃ¢mera
      const dt = new DataTransfer();
      
      // Adiciona fotos jÃ¡ existentes
      for (let i = 0; i < fotosInput.files.length; i++) {
        dt.items.add(fotosInput.files[i]);
      }
      
      // Adiciona nova foto da cÃ¢mera
      for (let i = 0; i < cameraFiles.length; i++) {
        dt.items.add(cameraFiles[i]);
      }
      
      // Atualiza o input principal
      fotosInput.files = dt.files;
      
      console.log('ğŸ“· Foto adicionada! Total:', fotosInput.files.length, 'fotos');
      
      // Limpa o input da cÃ¢mera
      this.value = '';
    }
  });
});

// INICIALIZAÃ‡ÃƒO
setInterval(updateClock, 1000);
updateClock();
updateWeather('CAMPINAS');

console.log('âœ… Sistema iniciado com', Object.keys(lojas).length, 'lojas');
console.log('âœ… FunÃ§Ã£o selecionarEmoji() carregada - SEM setStatus');
</script>
</body>
</html>